function numericEntitiesDecode(a){return a.replace(/&#(\d+);/g,function(){return String.fromCharCode(arguments[1])}).replace(/&nbsp;/ig,"\u00a0")}var spipDialog;var spipLinks;function loadSelectFromSpipJSON(b,c,a,d){jQuery.getJSON(c,function(f){var e=b.getContentElement(a,d);e.clear();b.options[a][d]={};jQuery.each(f,function(g,i){if(i.id!="-1"){var j,h="";j=i.level;while(j-->0){h=h+"\u00a0\u00a0"}if(h){h=h+"\u21b3"}e.add(h+numericEntitiesDecode(i.titre),g);b.options[a][d][g]=i}});if(d=="selectCategorie"){updateItem(b)}})}function ucfirst(a){var b=a.match(/^(.)(.*)$/);return b[1].toUpperCase()+b[2]}function updateItem(c){if(c){var e=c.getValueOf("tab1","selectType");var a=c.getContentElement("tab1","selectCategorie");var b=c.getContentElement("tab1","selectItem");var d=c.getParentEditor();if(a.getLabel()!=numericEntitiesDecode(spipLinks[e].nomCategorie)){a.setLabel(numericEntitiesDecode(spipLinks[e].nomCategorie));loadSelectFromSpipJSON(c,spipLinks[e].selectCategorie,"tab1","selectCategorie")}if(spipLinks[e].selectItem){b.setLabel(numericEntitiesDecode(spipLinks[e].nomItem));b.getElement().show();var f=c.getValueOf("tab1","selectCategorie");if(c.options.tab1["selectCategorie"][f]){loadSelectFromSpipJSON(c,spipLinks[e].selectItem+c.options.tab1["selectCategorie"][f].id,"tab1","selectItem")}}else{b.setLabel("");b.getElement().hide()}}}CKEDITOR.dialog.add("spip",function(b){var a;return{title:b.lang.spip.title,minWidth:360,minHeight:150,onLoad:function(){spipDialog=a=this;this.options={tab1:{selectCategorie:{},selectItem:{}}};this.setupContent();if(CKEDITOR.env.ie7Compat){a.parts.contents.setStyle("overflow","hidden")}},onShow:function(){var d=this.getParentEditor();if(d.getSelection()){var c;if(CKEDITOR.env.ie){c=d.getSelection().document.$.selection.createRange().text}else{c=d.getSelection().getNative()}this.setValueOf("tab1","linkText",c)}jQuery.getJSON(CKEDITOR.spipurl+"?page=spiplinks-json",function(f){var e=a.getContentElement("tab1","selectType");e.clear();spipLinks=f;jQuery.each(spipLinks,function(g,h){e.add(numericEntitiesDecode(h.label),g)});updateItem(a)})},onOk:function(){var k,d,j;if(spipLinks[this.getValueOf("tab1","selectType")].selectItem){k=this.getValueOf("tab1","selectItem");j=this.options.tab1["selectItem"][k].titre;d=this.options.tab1["selectItem"][k].url}else{k=this.getValueOf("tab1","selectCategorie");j=this.options.tab1["selectCategorie"][k].titre;d=this.options.tab1["selectCategorie"][k].url}j=j.replace(/^(\s|&#160;)+/g,"");var h=this.getParentEditor();var c=h.getSelection();var f=c.getSelectedElement();var m=this.getValueOf("tab1","linkText");var l=(m?m:j);if(f&&(f.getName()=="a")){if(m){f.setText(m)}f.setAttribute("href",d);h.insertElement(f)}else{if(f&&(f.getParent().getName()=="a")){var e=f.getParent();if(m){e.setText(m)}e.setAttribute("href",d);h.insertElement(e)}else{if(f&&(f.getName()=="img")){var i=h.document.createElement("a");i.setAttribute("href",d);if(m){i.setText(m)}i.append(f.clone());h.insertElement(i)}else{var g=h.getSelection().getRanges()[0].startContainer.getParent();if(g.getName()=="a"){if(m){g.setText(m)}g.setAttribute("href",d)}else{var i=h.document.createElement("a");i.setAttribute("href",d);i.setText(numericEntitiesDecode(l));h.insertElement(i)}}}}},contents:[{id:"tab1",label:"",title:"",expand:true,padding:0,elements:[{id:"",type:"vbox",children:[{id:"linkText",type:"text",label:b.lang.spip.linktext},{id:"",type:"hbox",children:[{id:"selectType",label:b.lang.spip.linktype,type:"select",items:[],onChange:function(){updateItem(a)}},{id:"",type:"vbox",children:[{id:"selectCategorie",label:"_",type:"select",items:[],onChange:function(){updateItem(a)}},{id:"selectItem",label:"_",type:"select",items:[]}]}]}]}]}],buttons:[CKEDITOR.dialog.okButton,CKEDITOR.dialog.cancelButton]}});