(function(){var n=1,c=4,h=8,m=/^\s*(\d+)((px)|\%)?\s*$/i,i=/(^\s*(\d+)((px)|\%)?\s*$)|^$/i,b=/^(.*)\?docid=(\d+)(?:(&amp;|&)doctype=(\w+))?((&amp;|&)docparam=(.*))?$/,g=false;var e=function(A,u,r){if(!g){g=true;var w=A.getDialog();var q=w.getValueOf("info","docId"),v=w.getValueOf("info","docType"),x=w.getValueOf("info","docParam"),p=w.getValueOf("info","txtUrl"),z=/^.*\/([^-]+).*?\.(png|gif|jpe?g)$/;if(p){var y=p.match(b);if(y){var s=y[1].match(z);if(s&&((s[1].toLowerCase()=="mp3")||(s[1].toLowerCase()=="flv"))&&(!x.match(/^(.*\|)?player(\|.*)?$/))){if((r=="txtUrl")&&confirm(u.lang.spipdoc.multimedia_content_add_player)){w.setValueOf("info","docType","doc");v="doc";if(x){x="player|"+x}else{x="player"}w.setValueOf("info","docParam",x)}}if(y[7]==undefined){y[7]=""}var t=(q!=y[2])||(v!=y[4])||(x!=y[7]);if(true){var o=y[1]+"?docid="+q+"&doctype="+v;if(x){o=o+"&docparam="+encodeURI(x)}w.setValueOf("info","txtUrl",o)}}}g=false}return true};var l=function(){var q=this.getValue(),p=this.getDialog(),o=q.match(m);if(o){if(o[2]=="%"){k(p,false)}q=o[1]}if(p.lockRatio){var r=p.originalElement;if(r.getCustomData("isReady")=="true"){if(this.id=="txtHeight"){if(q&&q!="0"){q=Math.round(r.$.width*(q/r.$.height))}if(!isNaN(q)){p.setValueOf("info","txtWidth",q)}}else{if(q&&q!="0"){q=Math.round(r.$.height*(q/r.$.width))}if(!isNaN(q)){p.setValueOf("info","txtHeight",q)}}}}a(p)};var a=function(o){if(!o.originalElement||!o.preview){return 1}o.commitContent(c,o.preview);return 0};var k=function(p,s){var v=p.originalElement,r=CKEDITOR.document.getById("btnLockSizes");if(v.getCustomData("isReady")=="true"){if(s=="check"){var q=p.getValueOf("info","txtWidth"),o=p.getValueOf("info","txtHeight"),u=v.$.width*1000/v.$.height,t=q*1000/o;p.lockRatio=false;if(!q&&!o){p.lockRatio=true}else{if(!isNaN(u)&&!isNaN(t)){if(Math.round(u)==Math.round(t)){p.lockRatio=true}}}}else{if(s!=undefined){p.lockRatio=s}else{p.lockRatio=!p.lockRatio}}}else{if(s!="check"){p.lockRatio=false}}if(p.lockRatio){r.removeClass("cke_btn_unlocked")}else{r.addClass("cke_btn_unlocked")}return p.lockRatio};var j=function(o){var p=o.originalElement;if(p.getCustomData("isReady")=="true"){o.setValueOf("info","txtWidth",p.$.width);o.setValueOf("info","txtHeight",p.$.height)}a(o)};var d=function(r,q){if(r!=n){return}function u(x,v){var w=x.match(m);if(w){if(w[2]=="%"){w[1]+="%";k(p,false)}return w[1]}return v}var p=this.getDialog(),s="",t=((this.id=="txtWidth")?"width":"height"),o=q.getAttribute(t);if(o){s=u(o,s)}s=u(q.$.style[t],s);this.setValue(s)};var f=function(p,r){var o=function(){var s=this.originalElement;s.setCustomData("isReady","true");s.removeListener("load",o);s.removeListener("error",q);s.removeListener("abort",q);CKEDITOR.document.getById("ImagePreviewLoader").setStyle("display","none");if(!this.dontResetSize){j(this)}if(this.firstLoad){k(this,"check")}this.firstLoad=false;this.dontResetSize=false};var q=function(){var t=this.originalElement;t.removeListener("load",o);t.removeListener("error",q);t.removeListener("abort",q);var s=CKEDITOR.getUrl(p.skinPath+"images/noimage.png");if(this.preview){this.preview.setAttribute("src",s)}CKEDITOR.document.getById("ImagePreviewLoader").setStyle("display","none");k(this,false)};return{title:p.lang.spipdoc.title,minWidth:420,minHeight:310,onShow:function(){this.imageElement=false;this.imageEditMode=false;this.lockRatio=true;this.dontResetSize=false;this.firstLoad=true;CKEDITOR.document.getById("ImagePreviewLoader").setStyle("display","none");this.preview=CKEDITOR.document.getById("previewImage");var t=this.getParentEditor(),u=this.getParentEditor().getSelection(),s=u.getSelectedElement();this.originalElement=t.document.createElement("img");this.originalElement.setAttribute("alt","");this.originalElement.setCustomData("isReady","false");if(s&&s.getName()=="img"&&!s.getAttribute("_cke_protected_html")){this.imageEditMode="img"}if(this.imageEditMode||this.imageElement){if(!this.imageElement){this.imageElement=s}this.setupContent(n,this.imageElement);k(this,true)}},onOk:function(){this.imageElement=p.document.createElement("img");this.imageElement.setAttribute("alt","");this.commitContent(n,this.imageElement);if(CKEDITOR.ckConfig.vignette){this.imageElement.setStyle("max-width",CKEDITOR.ckConfig.vignette+"px");this.imageElement.setStyle("max-height",CKEDITOR.ckConfig.vignette+"px");this.imageElement.setStyle("width","");this.imageElement.setStyle("height","");this.imageElement.setAttribute("width","");this.imageElement.setAttribute("height","")}p.insertElement(this.imageElement)},onLoad:function(){var s=this._.element.getDocument();this.addFocusable(s.getById("btnResetSize"),5);this.addFocusable(s.getById("btnLockSizes"),5)},onHide:function(){if(this.preview){this.commitContent(h,this.preview)}if(this.originalElement){this.originalElement.removeListener("load",o);this.originalElement.removeListener("error",q);this.originalElement.removeListener("abort",q);this.originalElement.remove();this.originalElement=false}},contents:[{id:"info",label:p.lang.spipdoc.infoTab,accessKey:"I",elements:[{type:"vbox",padding:0,children:[{type:"html",html:"<span>"+CKEDITOR.tools.htmlEncode(p.lang.spipdoc.url)+"</span>"},{type:"hbox",widths:["280px","110px"],align:"right",children:[{id:"txtUrl",type:"text",label:"",onChange:function(){var v=this.getDialog(),w=this.getValue();if(w.length>0){v=this.getDialog();if(!g){g=true;var t=w.match(b);if(t){if(t[7]){v.setValueOf("info","docParam",decodeURI(t[7]))}if(t[4]){v.setValueOf("info","docType",t[4])}v.setValueOf("info","docId",t[2])}else{v.setValueOf("info","docParam","");v.setValueOf("info","docType","");v.setValueOf("info","docId","");alert("là")}g=false;e(this,p,"txtUrl")}var u=v.originalElement;if(u){u.setCustomData("isReady","false");var s=CKEDITOR.document.getById("ImagePreviewLoader");if(s){s.setStyle("display","")}u.on("load",o,v);u.on("error",q,v);u.on("abort",q,v);u.setAttribute("src",w)}v.preview.setAttribute("src",w);a(v)}},setup:function(u,t){if(u==n){var s=t.getAttribute("src");var v=this;this.getDialog().dontResetSize=true;setTimeout(function(){v.setValue(s);v.focus()},0)}},commit:function(t,s){if(t==n&&(this.getValue()||this.isChanged())){s.setAttribute("src",decodeURI(this.getValue()))}else{if(t==h){s.setAttribute("src","");s.removeAttribute("src")}}}},{type:"button",id:"browse",align:"center",label:p.lang.spipdoc.browseServer,hidden:true,filebrowser:"info:txtUrl"}]}]},{type:"hbox",widths:["140px","240px"],children:[{type:"vbox",padding:10,children:[{type:"hbox",widths:["70%","30%"],children:[{type:"vbox",padding:1,children:[{type:"text",width:"40px",id:"txtWidth",labelLayout:"horizontal",label:p.lang.spipdoc.width,onKeyUp:l,validate:function(){var s=this.getValue().match(i);if(!s){alert(p.lang.common.validateNumberFailed)}return !!s},setup:d,commit:function(u,t){if(u==n){var v=this.getValue();if(v){t.setAttribute("width",v)}else{if(!v&&this.isChanged()){t.removeAttribute("width")}}}else{if(u==c){v=this.getValue();var s=v.match(m);if(!s){var w=this.getDialog().originalElement;if(w.getCustomData("isReady")=="true"){t.setStyle("width",w.$.width+"px")}}else{t.setStyle("width",v+"px")}}else{if(u==h){t.setStyle("width","0px");t.removeAttribute("width");t.removeStyle("width")}}}}},{type:"text",id:"txtHeight",width:"40px",labelLayout:"horizontal",label:p.lang.spipdoc.height,onKeyUp:l,validate:function(){var s=this.getValue().match(i);if(!s){alert(p.lang.common.validateNumberFailed)}return !!s},setup:d,commit:function(u,t){if(u==n){var v=this.getValue();if(v){t.setAttribute("height",v)}else{if(!v&&this.isChanged()){t.removeAttribute("height")}}}else{if(u==c){v=this.getValue();var s=v.match(m);if(!s){var w=this.getDialog().originalElement;if(w.getCustomData("isReady")=="true"){t.setStyle("height",w.$.height+"px")}}else{t.setStyle("height",v+"px")}}else{if(u==h){t.setStyle("height","0px");t.removeAttribute("height");t.removeStyle("height")}}}}}]},{type:"html",style:"margin-top:10px;width:40px;height:40px;",onLoad:function(){var s=CKEDITOR.document.getById("btnResetSize"),t=CKEDITOR.document.getById("btnLockSizes");if(s){s.on("click",function(){j(this)},this.getDialog());s.on("mouseover",function(){this.addClass("cke_btn_over")},s);s.on("mouseout",function(){this.removeClass("cke_btn_over")},s)}if(t){t.on("click",function(){var v=k(this),x=this.originalElement,w=this.getValueOf("info","txtWidth");if(x.getCustomData("isReady")=="true"&&w){var u=x.$.height/x.$.width*w;if(!isNaN(u)){this.setValueOf("info","txtHeight",Math.round(u));a(this)}}},this.getDialog());t.on("mouseover",function(){this.addClass("cke_btn_over")},t);t.on("mouseout",function(){this.removeClass("cke_btn_over")},t)}},html:'<div><a href="javascript:void(0)" tabindex="-1" title="'+p.lang.spipdoc.lockRatio+'" class="cke_btn_locked" id="btnLockSizes"></a><a href="javascript:void(0)" tabindex="-1" title="'+p.lang.spipdoc.resetSize+'" class="cke_btn_reset" id="btnResetSize"></a></div>'}]},{type:"html",html:"<div style=\"width:250px;white-space:normal;margin:0;padding:0;\">Les informations de largeur et hauteur ne servent que pour la prévisualisation dans l'éditeur.<br/>Pour les modifier effectivement, il faut utiliser l'interface de SPIP.</div>"},{type:"vbox",padding:1,children:[{id:"cmbAlign",type:"select",labelLayout:"horizontal",widths:["35%","65%"],style:"width:90px",label:p.lang.spipdoc.align,"default":"",items:[[p.lang.spipdoc.alignMiddle,"middle"],[p.lang.spipdoc.alignLeft,"left"],[p.lang.spipdoc.alignRight,"right"]],onChange:function(){a(this.getDialog())},setup:function(t,s){if(t==n){this.setValue(s.getAttribute("align"))}},commit:function(t,s){var u=this.getValue();if(t==n){if(u||this.isChanged()){s.setAttribute("align",u)}if(u=="middle"){s.setStyle("display","block");s.setStyle("margin-left","auto");s.setStyle("margin-right","auto")}else{s.setStyle("display","");s.setStyle("margin-left","");s.setStyle("margin-right","")}}else{if(t==c){s.setAttribute("align",this.getValue());if(u=="absMiddle"||u=="middle"){s.setStyle("vertical-align","middle")}else{if(u=="top"||u=="textTop"){s.setStyle("vertical-align","top")}else{s.removeStyle("vertical-align")}}if(u=="right"||u=="left"){s.setStyle("styleFloat",u)}else{s.removeStyle("styleFloat")}if(u=="middle"){s.setStyle("display","block");s.setStyle("margin-left","auto");s.setStyle("margin-right","auto")}else{s.setStyle("display","");s.setStyle("margin-left","");s.setStyle("margin-right","")}}else{if(t==h){s.removeAttribute("align")}}}}}]}]},{type:"vbox",height:"250px",children:[{type:"html",style:"width:95%;",html:"<div>"+CKEDITOR.tools.htmlEncode(p.lang.spipdoc.preview)+'<br><div id="ImagePreviewLoader" style="display:none"><div class="loading">&nbsp;</div></div><div style="width:200px;height:200px;overflow:scroll;"><div id="ImagePreviewBox" style="white-space:normal;"><a href="javascript:void(0)" target="_blank" onclick="return false;" id="previewLink"><img id="previewImage" src="" alt="" /></a>Lorem ipsum dolor sit amet, consectetuer adipiscing elit. Maecenas feugiat consequat diam. Maecenas metus. Vivamus diam purus, cursus a, commodo non, facilisis vitae, nulla. Aenean dictum lacinia tortor. Nunc iaculis, nibh non iaculis aliquam, orci felis euismod neque, sed ornare massa mauris sed velit. Nulla pretium mi et risus. Fusce mi pede, tempor id, cursus ac, ullamcorper nec, enim. Sed tortor. Curabitur molestie. Duis velit augue, condimentum at, ultrices a, luctus ut, orci. Donec pellentesque egestas eros. Integer cursus, augue in cursus faucibus, eros pede bibendum sem, in tempus tellus justo quis ligula. Etiam eget tortor. Vestibulum rutrum, est ut placerat elementum, lectus nisl aliquam velit, tempor aliquam eros nunc nonummy metus. In eros metus, gravida a, gravida sed, lobortis id, turpis. Ut ultrices, ipsum at venenatis fringilla, sem nulla lacinia tellus, eget aliquet turpis mauris non enim. Nam turpis. Suspendisse lacinia. Curabitur ac tortor ut ipsum egestas elementum. Nunc imperdiet gravida mauris.</div></div></div>'}]}]},{type:"hbox",padding:1,widths:["50%","50%"],children:[{id:"docId",type:"text",label:p.lang.spipdoc.docid,style:"width: 60%",onChange:function(){e(this,p,"docId")}},{id:"docType",type:"select",label:p.lang.spipdoc.doctype,labelLayout:"vertical",items:[["Image","img"],["Incorporé","emb"],["Document","doc"],["Vidéo","video"],["Audio","audio"],["Texte","text"]],onChange:function(){e(this,p,"docType")}}]},{id:"docParam",label:p.lang.spipdoc.spip_parameters,type:"text",onChange:function(){e(this,p,"docParam")}}]}]}};CKEDITOR.dialog.add("spipdoc",function(o){return f(o,"spipdoc")});CKEDITOR.dialog.add("spipdocbutton",function(o){return f(o,"spipdocbutton")})})();